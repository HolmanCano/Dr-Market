<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagar | Dr-Market</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/landing-theme.css">
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=EUR"></script>
  </head>
  <body>
    <header>
      <div class="container nav">
        <a class="brand" href="landing.html#inicio">
          <span class="brand-logo" aria-hidden="true"></span>
          <span>Dr'Market</span>
        </a>
        <nav class="nav-actions" aria-label="Principal">
          <a class="btn" href="landing.html#inicio">Inicio</a>
          <a class="btn" href="index.html">Tienda</a>
          <a class="btn" href="nosotros.html">Nosotros</a>
          <a class="btn btn-cart" href="carrito.html">
            <span class="cart-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" focusable="false">
                <path d="M7.75 20a1.75 1.75 0 1 1 0-3.5 1.75 1.75 0 0 1 0 3.5Zm8.5 0a1.75 1.75 0 1 1 0-3.5 1.75 1.75 0 0 1 0 3.5ZM4.25 4.5h-1.5V3h2.1a1.25 1.25 0 0 1 1.2.9l.36 1.3H21.5a.75.75 0 0 1 .72.96l-2 7.25a1.75 1.75 0 0 1-1.68 1.29H9.24l-.37 1.36h11.63v1.5H7.59a1.25 1.25 0 0 1-1.2-1.6l1.02-3.76-2.22-8.2Z"/>
              </svg>
            </span>
            <span class="cart-text">Carrito</span>
            <span class="cart-count" data-cart-count aria-live="polite">0</span>
          </a>
        </nav>
      </div>
    </header>

    <main>
      <section class="surface-block">
        <h1 class="section-title">Finalizar compra</h1>
        <p class="section-sub">Completa tus datos para calcular el env&iacute;o y confirmar el pago.</p>

        <div class="card" data-step="shipping">
          <div class="checkout-step-header">Paso 1 de 2</div>
          <h2>Datos de env&iacute;o</h2>
          <p class="checkout-step-sub">Enviamos desde Espa&ntilde;a a direcciones dentro de la Uni&oacute;n Europea.</p>
          <form id="shipping-form" class="form" novalidate>
            <div class="form-grid two-columns">
              <div class="field">
                <label for="shipping-nombre">Nombre</label>
                <input id="shipping-nombre" name="nombre" type="text" autocomplete="given-name" required>
              </div>
              <div class="field">
                <label for="shipping-apellido">Apellido</label>
                <input id="shipping-apellido" name="apellido" type="text" autocomplete="family-name" required>
              </div>
              <div class="field">
                <label for="shipping-email">Correo electr&oacute;nico</label>
                <input id="shipping-email" name="email" type="email" autocomplete="email" required>
              </div>
              <div class="field">
                <label for="shipping-telefono">Tel&eacute;fono</label>
                <input id="shipping-telefono" name="telefono" type="tel" autocomplete="tel" required>
              </div>
            </div>
            <div class="form-grid">
              <div class="field">
                <label for="shipping-direccion">Direcci&oacute;n</label>
                <input id="shipping-direccion" name="direccion" type="text" autocomplete="address-line1" required>
              </div>
              <div class="field">
                <label for="shipping-direccion2">Detalles adicionales (opcional)</label>
                <input id="shipping-direccion2" name="direccion2" type="text" autocomplete="address-line2" placeholder="Piso, puerta o referencia">
              </div>
            </div>
            <div class="form-grid three-columns">
              <div class="field">
                <label for="shipping-ciudad">Ciudad</label>
                <input id="shipping-ciudad" name="ciudad" type="text" autocomplete="address-level2" required>
              </div>
              <div class="field">
                <label for="shipping-provincia">Provincia / Estado</label>
                <input id="shipping-provincia" name="provincia" type="text" autocomplete="address-level1" required>
              </div>
              <div class="field">
                <label for="shipping-postal">C&oacute;digo postal</label>
                <input id="shipping-postal" name="codigo_postal" type="text" inputmode="numeric" autocomplete="postal-code" required>
              </div>
            </div>
            <div class="form-grid two-columns">
              <div class="field">
                <label for="shipping-pais">Pa&iacute;s</label>
                <select id="shipping-pais" name="pais" autocomplete="country-name" required>
                  <option value="" disabled selected>Selecciona un pa&iacute;s</option>
                  <option value="ES">Espa&ntilde;a</option>
                  <option value="PT">Portugal</option>
                  <option value="FR">Francia</option>
                  <option value="DE">Alemania</option>
                  <option value="IT">Italia</option>
                  <option value="BE">B&eacute;lgica</option>
                  <option value="NL">Pa&iacute;ses Bajos</option>
                  <option value="AT">Austria</option>
                  <option value="IE">Irlanda</option>
                  <option value="LU">Luxemburgo</option>
                  <option value="DK">Dinamarca</option>
                  <option value="SE">Suecia</option>
                  <option value="FI">Finlandia</option>
                  <option value="NO">Noruega</option>
                </select>
              </div>
              <div class="field">
                <label for="shipping-notas">Notas para el repartidor (opcional)</label>
                <input id="shipping-notas" name="notas" type="text" autocomplete="off" placeholder="Horario preferido, accesos, etc.">
              </div>
            </div>
            <p class="shipping-estimate" id="shipping-estimate">Selecciona el pa&iacute;s para estimar el costo de env&iacute;o.</p>
            <div class="form-actions">
              <a class="btn" href="carrito.html">Volver al carrito</a>
              <button class="btn btn-primary" id="to-payment" type="submit">Continuar al pago</button>
            </div>
          </form>
        </div>

        <div class="card" data-step="payment" hidden>
          <div class="checkout-step-header">Paso 2 de 2</div>
          <h2>Pago seguro</h2>
          <p class="checkout-step-sub">Verifica tu resumen antes de confirmar el pago.</p>
          <div class="shipping-resume" id="shipping-summary">
            <span class="shipping-resume-title">Datos de env&iacute;o</span>
            <span>Completa el paso anterior para ver la direcci&oacute;n.</span>
          </div>
          <div class="checkout-summary">
            <div class="checkout-summary-row">
              <span>Productos</span>
              <span id="items-total">0,00&nbsp;&euro;</span>
            </div>
            <div class="checkout-summary-row">
              <span>Env&iacute;o estimado</span>
              <span id="shipping-cost">Pendiente</span>
            </div>
            <div class="checkout-summary-row total">
              <span>Total a pagar</span>
              <strong id="total">0,00&nbsp;&euro;</strong>
            </div>
          </div>
          <div class="checkout-actions">
            <button class="btn" type="button" id="back-to-shipping">Modificar datos</button>
            <div class="checkout-paypal">
              <div id="paypal-button-container"></div>
              <div id="status" class="checkout-status" aria-live="polite"></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div class="footer-inner">
        <a class="footer-brand" href="landing.html#inicio">
          <span class="footer-logo" aria-hidden="true"></span>
          <span>Dr'Market</span>
        </a>
        <p>&copy; 2024 Dr'Market. Todos los derechos reservados.</p>
        <a href="mailto:hola@drmarket.com">hola@drmarket.com</a>
      </div>
    </footer>

    <script src="js/cart.js"></script>
    <script>
      (function () {
        const currency = "EUR";
        const STORAGE_KEY = "drmarket:shipping";
        const form = document.getElementById("shipping-form");
        const stepShipping = document.querySelector('[data-step="shipping"]');
        const stepPayment = document.querySelector('[data-step="payment"]');
        const shippingEstimateEl = document.getElementById("shipping-estimate");
        const shippingSummaryEl = document.getElementById("shipping-summary");
        const itemsTotalEl = document.getElementById("items-total");
        const shippingCostEl = document.getElementById("shipping-cost");
        const totalEl = document.getElementById("total");
        const statusEl = document.getElementById("status");
        const backBtn = document.getElementById("back-to-shipping");
        let paypalButtons = null;

        const shippingState = {
          data: null,
          cost: 0,
          estimate: ""
        };

        const countryLabels = {
          ES: "Espa\u00f1a",
          PT: "Portugal",
          FR: "Francia",
          DE: "Alemania",
          IT: "Italia",
          BE: "B\u00e9lgica",
          NL: "Pa\u00edses Bajos",
          AT: "Austria",
          IE: "Irlanda",
          LU: "Luxemburgo",
          DK: "Dinamarca",
          SE: "Suecia",
          FI: "Finlandia",
          NO: "Noruega"
        };

        const shippingRates = {
          ES: { cost: 4.95, estimate: "24-48 h" },
          PT: { cost: 6.95, estimate: "48-72 h" },
          FR: { cost: 7.95, estimate: "3-4 d\u00edas" },
          DE: { cost: 7.95, estimate: "3-4 d\u00edas" },
          IT: { cost: 7.95, estimate: "3-4 d\u00edas" },
          BE: { cost: 8.5, estimate: "4-5 d\u00edas" },
          NL: { cost: 8.5, estimate: "4-5 d\u00edas" },
          AT: { cost: 8.5, estimate: "4-5 d\u00edas" },
          IE: { cost: 9.5, estimate: "4-5 d\u00edas" },
          LU: { cost: 8.5, estimate: "4-5 d\u00edas" },
          DK: { cost: 9.5, estimate: "5-6 d\u00edas" },
          SE: { cost: 10.5, estimate: "5-6 d\u00edas" },
          FI: { cost: 10.5, estimate: "5-6 d\u00edas" },
          NO: { cost: 11.5, estimate: "5-7 d\u00edas" },
          DEFAULT: { cost: 12.5, estimate: "5-7 d\u00edas" }
        };

        function formatPrice(value) {
          if (window.cartManager?.formatPrice) {
            return window.cartManager.formatPrice(value);
          }
          return new Intl.NumberFormat("es-ES", { style: "currency", currency }).format(value);
        }

        function computeShipping(country) {
          if (!country) return shippingRates.DEFAULT;
          const code = String(country).toUpperCase();
          return shippingRates[code] || shippingRates.DEFAULT;
        }

        function showStep(step) {
          if (stepShipping) stepShipping.hidden = step !== "shipping";
          if (stepPayment) stepPayment.hidden = step !== "payment";
          if (step === "shipping" && statusEl) statusEl.textContent = "";
        }

        function updateTotals() {
          const itemsTotal = window.cartManager?.getTotalPrice
            ? window.cartManager.getTotalPrice()
            : 0;
          const grandTotal = itemsTotal + (Number(shippingState.cost) || 0);
          if (itemsTotalEl) itemsTotalEl.textContent = formatPrice(itemsTotal);
          if (shippingCostEl) {
            shippingCostEl.textContent = shippingState.cost
              ? formatPrice(shippingState.cost)
              : "Pendiente";
          }
          if (totalEl) totalEl.textContent = formatPrice(grandTotal);
          window.cartManager?.updateBadge?.();
          return { itemsTotal, grandTotal };
        }

        function updateEstimatePreview() {
          if (!shippingEstimateEl || !form) return;
          const country = form.elements?.pais?.value;
          if (!country) {
            shippingEstimateEl.textContent = "Selecciona el pa\u00eds para estimar el costo de env\u00edo.";
            return;
          }
          const estimate = computeShipping(country);
          shippingEstimateEl.textContent =
            "Costo estimado: " +
            formatPrice(estimate.cost) +
            " \u00b7 Entrega aproximada " +
            estimate.estimate;
        }

        function getCountryLabel(code) {
          return countryLabels[String(code).toUpperCase()] || code;
        }

        function updateShippingSummary() {
          if (!shippingSummaryEl) return;
          const data = shippingState.data;
          if (!data) {
            shippingSummaryEl.innerHTML =
              '<span class="shipping-resume-title">Datos de env&iacute;o</span>' +
              "<span>Completa el paso anterior para ver la direcci&oacute;n.</span>";
            return;
          }

          const addressLine = data.direccion2
            ? data.direccion + ", " + data.direccion2
            : data.direccion;

          const details = [
            '<span class="shipping-resume-title">Datos de env&iacute;o</span>',
            "<span>" + (data.nombre || "") + " " + (data.apellido || "") + "</span>",
            "<span>" + addressLine + "</span>",
            "<span>" + (data.codigo_postal || "") + " " + (data.ciudad || "") + ", " + (data.provincia || "") + "</span>",
            "<span>" + getCountryLabel(data.pais) + "</span>",
            "<span class=\"shipping-resume-meta\">Tel: " + (data.telefono || "") + "</span>",
            "<span class=\"shipping-resume-meta\">Entrega estimada: " + (shippingState.estimate || "Por confirmar") + "</span>"
          ];

          if (data.notas) {
            details.push('<span class="shipping-resume-meta">Notas: ' + data.notas + "</span>");
          }

          shippingSummaryEl.innerHTML = details.join("");
        }

        function persistShippingState() {
          try {
            sessionStorage.setItem(
              STORAGE_KEY,
              JSON.stringify({
                data: shippingState.data,
                cost: shippingState.cost,
                estimate: shippingState.estimate
              })
            );
          } catch {
            /* ignore persistence errors */
          }
        }

        function populateForm(data) {
          if (!form || !data) return;
          Object.entries(data).forEach(([key, value]) => {
            if (form.elements[key]) {
              form.elements[key].value = value;
            }
          });
        }

        function loadSavedShipping() {
          try {
            const saved = sessionStorage.getItem(STORAGE_KEY);
            if (!saved) return;
            const parsed = JSON.parse(saved);
            if (!parsed?.data) return;
            shippingState.data = parsed.data;
            shippingState.cost = Number(parsed.cost) || 0;
            shippingState.estimate = parsed.estimate || "";
            populateForm(parsed.data);
            updateEstimatePreview();
            updateShippingSummary();
            updateTotals();
            showStep("payment");
            ensurePayPalButtons();
          } catch {
            /* ignore corrupted data */
          }
        }

        function ensurePayPalButtons() {
          if (paypalButtons) return;
          if (typeof paypal === "undefined") {
            if (statusEl) {
              statusEl.textContent = "Cargando PayPal\u2026";
            }
            setTimeout(ensurePayPalButtons, 1200);
            return;
          }

          if (statusEl) statusEl.textContent = "";

          paypalButtons = paypal
            .Buttons({
              style: { layout: "vertical", color: "gold", shape: "rect", label: "paypal" },
              createOrder: function (data, actions) {
                const totals = updateTotals();
                const amount = totals.grandTotal;
                const breakdown = {
                  item_total: {
                    value: totals.itemsTotal.toFixed(2),
                    currency_code: currency
                  },
                  shipping: {
                    value: (shippingState.cost || 0).toFixed(2),
                    currency_code: currency
                  }
                };

                const purchaseUnit = {
                  amount: {
                    value: amount.toFixed(2),
                    currency_code: currency,
                    breakdown
                  }
                };

                if (shippingState.data) {
                  const data = shippingState.data;
                  purchaseUnit.shipping = {
                    name: {
                      full_name: (data.nombre || "") + " " + (data.apellido || "")
                    },
                    address: {
                      address_line_1: data.direccion || "",
                      address_line_2: data.direccion2 || undefined,
                      admin_area_2: data.ciudad || "",
                      admin_area_1: data.provincia || "",
                      postal_code: data.codigo_postal || "",
                      country_code: (data.pais || "ES").toUpperCase()
                    }
                  };
                }

                return actions.order.create({
                  purchase_units: [purchaseUnit]
                });
              },
              onApprove: async function (data, actions) {
                if (!actions?.order) return;
                try {
                  const details = await actions.order.capture();
                  if (statusEl) {
                    const buyer = details?.payer?.name?.given_name || "cliente";
                    statusEl.textContent = "Pago realizado por " + buyer + ". \u00a1Gracias!";
                  }
                  window.cartManager?.clearCart?.();
                  sessionStorage.removeItem(STORAGE_KEY);
                } catch (error) {
                  console.error(error);
                  if (statusEl) {
                    statusEl.textContent = "Ocurri\u00f3 un error al procesar el pago.";
                  }
                }
              },
              onError: function (err) {
                console.error(err);
                if (statusEl) {
                  statusEl.textContent = "Ocurri\u00f3 un error al procesar el pago.";
                }
              }
            })
            .render("#paypal-button-container");
        }

        function handleShippingSubmit(event) {
          event.preventDefault();
          if (!form) return;
          if (typeof form.reportValidity === "function") {
            if (!form.reportValidity()) return;
          } else if (typeof form.checkValidity === "function") {
            if (!form.checkValidity()) return;
          }

          const data = Object.fromEntries(new FormData(form).entries());
          const rate = computeShipping(data.pais);
          shippingState.data = data;
          shippingState.cost = rate.cost;
          shippingState.estimate = rate.estimate;
          persistShippingState();
          updateShippingSummary();
          updateTotals();
          showStep("payment");
          ensurePayPalButtons();
          if (shippingEstimateEl) {
            shippingEstimateEl.textContent =
              "Costo estimado: " +
              formatPrice(rate.cost) +
              " \u00b7 Entrega aproximada " +
              rate.estimate;
          }
          if (stepPayment) {
            stepPayment.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        }

        function handleBackClick() {
          showStep("shipping");
          if (stepShipping) {
            stepShipping.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        }

        if (form) {
          form.addEventListener("submit", handleShippingSubmit);
          form.addEventListener("change", updateEstimatePreview);
          form.addEventListener("input", (event) => {
            if (event.target && event.target.name === "pais") {
              updateEstimatePreview();
            }
          });
        }

        if (backBtn) {
          backBtn.addEventListener("click", handleBackClick);
        }

        if (window.cartManager?.addListener) {
          window.cartManager.addListener(updateTotals);
        }

        updateTotals();
        updateEstimatePreview();
        loadSavedShipping();
      })();
    </script>
  </body>
</html>
